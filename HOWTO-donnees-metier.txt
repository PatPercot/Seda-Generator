/*****************************************************************************************
 * 
 * Générateur de bordereaux de transfert guidé par le profil d'archivage
 *                         -----------------------
 * Département du Morbihan
 * Direction des systèmes d'information
 * Service Études
 * Patrick Percot
 * Mai 2015
 * 
 * Réutilisation du code autorisée dans l'intérêt des collectivités territoriales
 * 
 * ****************************************************************************************/

Guide de production des données métier


0) Principes de base

Les données sont produites sous forme d'un fichier texte de type CSV. Il n'y a pas d'ordre
particulier dans la production des données.

Chaque ligne est précédée du séparateur de champs qu'elle utilise. C'est ce premier caractère 
de chaque ligne qui est utilisé pour séparer les champs. Le séparateur peut être différent 
d'une ligne à l'autre.

L'ordre de production des lignes est quelconque. Elles n'ont pas à suivre la logique du profil
d'archivage.


1) Données générales

Nom du transfert (xpath[//TransferName]) : 
- le premier champ contient #TransferName 
- le second champ contient le texte
Exemple :
;#TransferName;Flux comptable PES Aller, recette - dépense - pièces justificatives en date du 2014-12-01, Département du Morbihan, Budget Principal, 07100

Nom du producteur (xpath[//OriginatingAgency/Name]) : 
- le premier champ contient #OriginatingAgency_Name 
- le second champ contient le texte
Exemple :
,#OriginatingAgency_Name,Département du Morbihan - Direction des affaires financières

Ainsi de suite pour toutes les balises qui peuvent être demandées par le profil d'archivage.

À ce jour, les données de contact ne sont pas gérées.

2) Unités documentaires simples

Les unités documentaires du profil d'archivage sont marquées par un TAG. 
Ce TAG est utilisé pour identifier les informations ou documents qui vont être produits
dans cette unité documentaire.


Nom de l'unité documentaire :
- le premier champ contient #ContainsName postfixé par le TAG de l'unité documentaire entre 
  crochets droits ;
- le second champ contient le texte
Exemple :
,#ContainsName[PES],Flux PES_Aller PESALR120710560900020141201121403628


Documents à produire dans l'unité documentaire :
- le premier champ contient le nom du fichier ;
- le second champ contient le TAG de l'unité documentaire ;
- le troisième champ contient la description du document ;
- le quatrième champ contient la date de création du document ;
[ les champs qui suivent peuvent ne pas exister, dans ce cas, ces métadonnées sont calculées par le générateur ]
- le cinquième champ contient le type d'algorithme utilisé pour le calcul d'empreinte ;
- le sixième champ contient l'empreinte du document ;
- le septième champ contient la taille en octets du document.
Exemple :
,PESALR120710560900020141201121403628-sig.xml,PES,Flux des mandats transférés à la DgFIP,2014-12-01;http://www.w3.org/2001/04/xmlenc#sha256;f81ba5573d70bb23c5510237208e2965bd87a389623c985cff341879e373c4b7;12345


2) Unités documentaires répétées

Les unités documentaires du profil d'archivage sont marquées par un TAG suivi d'un +. 
Les données métier liés à ce type de tag porteront un numéro indiquant leur ordre
de production.

Un exemple pour illustrer l'utilité des unités documentaires répétées :
- une procédure de marchés publics peut contenir des lots, une entreprise peut répondre à un
  lot mais pas aux autres, pour chaque lot on peut avoir des dossiers de candidature retenues
  ou rejetées.
  LOT 1
	Réponses rejetées
		Entreprise 1
			Candidature
			Engagement
		Entreprise 2
			Candidature
			Engagement
  LOT 2
	Réponses retenues
		Entreprise 1
			Candidature
			Engagement
	Réponses rejetées
		Entreprise 1
			Candidature
			Engagement

Ce TAG suivi d'un numéro encadré par des crochets droits est utilisé pour identifier les 
informations ou documents qui vont être produits dans cette unité documentaire.

Quand une unité documentaire répétée contient des unités documentaires répétées, il est possible
d'indiquer l'appartenance à ces sous-unités documentaires par une indication de chemin relatif
symbolisée par deux / successifs.

Les TAGs peuvent donc prendre les formes suivantes :
LOT[#1] : unité documentaire LOT, première occurrence
LOT[#2] : unité documentaire LOT, seconde occurrence
LOT[#3]//OFFRE_ETP[#2] : offre de la seconde entreprise pour le troisième lot 
LOT[#1]//ONR_ETP[#2]//ENGAGT : engagement de la seconde entreprise pour le premier lot

Exemple pour un nom d'unité documentaire :
,#ContainsName[LOT[#3]],Réfection de la cantine du lycée
,#ContainsName[LOT[#3]//OFFRE_ETP[#2]],offre entreprise 2 lot 3

Exemple pour un document :
,document2e2l1nr.txt,LOT[#1]//OFFRE_ETP[#2]//ENGAGT,Engagement ETP 2 LOT 1,01/12/2014 12:00:00


3) Documents identifiés 

Dans certaines unités documentaires, il peut y avoir des documents qui jouent un rôle différent.
Cela peut éviter de créer des unités documentaires supplémentaires pour servir de conteneur à 
ces documents.

La notation à utiliser pour les documents est TAG du document entre accolades. Ce TAG est accolé au
TAG des unités documentaires.

Exemples de documents:
,PESALRxxx.xml,PES{FLUX},Flux comptable PES,01/12/2014 12:00:00
,PES_ACK_xxx.xml,PES{ACCUSE_RECEPTION},Accusé de réception du flux comptable PES,02/12/2014 12:00:00
,document2e2l1nr.txt,LOT[#1]//OFFRE_ETP[#2]{ENGAGT},Engagement ETP 2 LOT 1,01/12/2014 12:00:00


4) Mots-clés

Les mots-clés de la description du contenu de l'archive sont produits en fonction de leur numéro d'ordre.
Le mot #KeywordContent est simplement postfixé d'un # suivi du numéro d'ordre encadrés par des crochets droits [].

,#KeywordContent[#1],Département du Morbihan
,#KeywordContent[#2],07100
,#KeywordContent[#3],SIRET : 22560001400016

Les mots-clés des unités documentaires sont produits en fonction de leur numéro d'ordre.
Le TAG de l'unité documentaire est concaténé au mot #KeywordContent suivi d'un _ postfixé d'un # suivi 
du numéro d'ordre encadrés par des crochets droits [].

,#KeywordContent_PES[#1],Bordereau 0701
,#KeywordContent_PES[#2],Pièce 5003
,#KeywordContent_OFFRE_ETP[#3][#1],mot-clé 1 pour l'offre d'entreprise 3
,#KeywordContent_OFFRE_ETP[#3][#2],mot-clé 2 pour l'offre d'entreprise 3

